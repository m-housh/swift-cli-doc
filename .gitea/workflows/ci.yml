---
name: CI
on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    name: Run tests.
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup MPR.
        run: |
          wget -qO - 'https://proget.makedeb.org/debian-feeds/prebuilt-mpr.pub' \
            | gpg --dearmor \
            | sudo tee /usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg 1> /dev/null \
          && echo "deb [arch=all,$(dpkg --print-architecture) signed-by=/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg] \
          https://proget.makedeb.org prebuilt-mpr $(lsb_release -cs)" \
          | sudo tee /etc/apt/sources.list.d/prebuilt-mpr.list \
          && sudo apt update
      - name: Setup just.
        run: sudo apt install -y just
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Run tests.
        run: just test-docker
